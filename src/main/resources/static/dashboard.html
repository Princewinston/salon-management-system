<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon Glow | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=4">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .table-container {
            background: var(--card-bg);
            border: var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #ddd;
        }

        th,
        td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: var(--primary-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">Salon Glow</div>
        <nav>
            <a href="index.html">Home</a>
            <a href="index.html#services">Services</a>
            <a href="dashboard.html" id="nav-dashboard" style="display: none;">Admin Dashboard</a>
            <a href="javascript:void(0)" id="nav-appointments" style="display: none;" onclick="openMyAppointments()">My
                Appointments</a>
            <a href="login.html" id="nav-login" class="btn" style="padding: 8px 20px; margin-left: 20px;">Login</a>
        </nav>
    </header>

    <div class="container">

        <!-- Products Section -->
        <section>
            <div class="section-header">
                <h2 class="section-title">Products</h2>
                <div>
                    <a href="index.html" class="btn btn-secondary"
                        style="margin-right: 10px; text-decoration: none; display: inline-block;">View Products</a>
                    <button class="btn"
                        onclick="openModal('product-modal'); document.getElementById('product-form').reset();">+ Add
                        Product</button>
                </div>
            </div>
            <div id="admin-product-list" class="grid" style="margin-bottom: 50px; display: none;">
                <!-- Hidden list -->
            </div>
        </section>

        <!-- Suppliers Section -->
        <section>
            <div class="section-header">
                <h2 class="section-title">Suppliers</h2>
                <button class="btn"
                    onclick="document.getElementById('supplier-form').reset(); document.getElementById('supp-id').value=''; openModal('supplier-modal')">+
                    Add Supplier</button>
            </div>
            <div id="supplier-list" class="grid" style="margin-bottom: 50px;">
                <!-- Loaded dynamically -->
            </div>
        </section>

        <!-- Purchase Orders Section -->
        <section>
            <div class="section-header">
                <h2 class="section-title">Purchase Orders</h2>
                <button class="btn" onclick="openModal('order-modal')">+ Create Order</button>
            </div>
            <div class="table-container">
                <table id="orders-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Supplier</th>
                            <th>Items</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Appointments Section -->
        <section>
            <div class="section-header">
                <h2 class="section-title">Appointments</h2>
            </div>
            <div class="table-container">
                <table id="appointments-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Date/Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <!-- Analytics Section -->
        <section id="analytics-section">
            <div class="section-header">
                <h2 class="section-title">Analytics & Reports</h2>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 50px;">
                <div class="card" style="padding: 20px; background: var(--card-bg);">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">Revenue Trends</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="card" style="padding: 20px; background: var(--card-bg);">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">Service Popularity</h3>
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <!-- Modals -->

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('product-modal')">&times;</span>
            <h2>Add Product</h2>
            <form id="product-form">
                <div class="form-group"><label>Name</label><input type="text" id="prod-name" required></div>
                <div class="form-group"><label>Description</label><input type="text" id="prod-desc"></div>
                <div class="form-group"><label>Price</label><input type="number" step="0.01" id="prod-price" required>
                </div>
                <!-- Stock field removed as per user request -->
                <div class="form-group"><label>Image URL</label><input type="text" id="prod-image"
                        placeholder="https://example.com/image.jpg"></div>
                <div class="form-group"><label>Category</label><input type="text" id="prod-cat-new"
                        placeholder="Enter Category Name (e.g. Hair)"></div>
                <button type="submit" class="btn" style="width: 100%">Save Product</button>
            </form>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplier-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('supplier-modal')">&times;</span>
            <h2>Add / Edit Supplier</h2>
            <form id="supplier-form">
                <input type="hidden" id="supp-id">
                <div class="form-group"><label>Name</label><input type="text" id="supp-name" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="supp-email" required></div>
                <div class="form-group"><label>Phone</label><input type="text" id="supp-phone" required></div>
                <div class="form-group"><label>Address</label><textarea id="supp-address" rows="2"></textarea></div>
                <button type="submit" class="btn" style="width: 100%">Save Supplier</button>
            </form>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('order-modal')">&times;</span>
            <h2>Create Purchase Order</h2>
            <form id="order-form">
                <div class="form-group"><label>Order #</label><input type="text" id="order-num" required></div>
                <div class="form-group"><label>Date</label><input type="date" id="order-date" required></div>
                <div class="form-group"><label>Supplier</label><select id="order-supplier" required></select></div>
                <div class="form-group"><label>Status</label>
                    <select id="order-status">
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%">Create Order</button>
            </form>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('item-modal')">&times;</span>
            <h2>Add Item to Order</h2>
            <form id="item-form">
                <input type="hidden" id="item-order-id">
                <div class="form-group"><label>Product</label><select id="item-product" required></select></div>
                <div class="form-group"><label>Quantity</label><input type="number" id="item-qty" required></div>
                <div class="form-group"><label>Unit Price</label><input type="number" step="0.01" id="item-price"
                        required></div>
                <button type="submit" class="btn" style="width: 100%">Add Item</button>
            </form>
        </div>
    </div>

    <!-- Cancel Modal -->
    <div id="cancel-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cancel-modal')">&times;</span>
            <h2>Cancel Appointment</h2>
            <p>Please tell us why this appointment is being cancelled:</p>
            <input type="hidden" id="cancel-appt-id">
            <textarea id="cancel-reason" rows="3"
                style="width: 100%; margin: 10px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc;"
                placeholder="Reason (e.g. Customer request, Staff unavailable)"></textarea>
            <button class="btn" style="width: 100%; background: #f00;" onclick="confirmCancellation()">Confirm
                Cancellation</button>
        </div>
    </div>

    <script src="script.js?v=4"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadSuppliers();
            loadOrders();
            // loadReturns();
            loadAppointments();
            loadAnalytics();

            document.getElementById('product-form').addEventListener('submit', saveProduct);
            document.getElementById('supplier-form').addEventListener('submit', saveSupplier);
            document.getElementById('order-form').addEventListener('submit', saveOrder);
            document.getElementById('item-form').addEventListener('submit', saveItem);
            // document.getElementById('return-form').addEventListener('submit', saveReturn);
        });

        // const API_URL = '/api'; // Inherited from script.js

        async function loadAnalytics() {
            try {
                const res = await fetch(`${API_URL}/analytics`);
                const data = await res.json();

                const ctxRev = document.getElementById('revenueChart').getContext('2d');
                const ctxServ = document.getElementById('serviceChart').getContext('2d');

                // Revenue Chart
                new Chart(ctxRev, {
                    type: 'line',
                    data: {
                        labels: data.revenueLabels, // Real Labels
                        datasets: [{
                            label: 'Revenue ($)',
                            data: data.revenueData, // Real Data
                            borderColor: '#8800ff',
                            backgroundColor: 'rgba(136, 0, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: 'white' } } },
                        scales: {
                            y: { ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#a0a0b0' }, grid: { display: false } }
                        }
                    }
                });

                // Service Popularity
                // Generate dynamic colors
                const colors = ['#fca311', '#ff0055', '#8800ff', '#00ff88', '#00bcd4', '#ffeb3b'];
                const bgColors = data.popularityLabels.map((_, i) => colors[i % colors.length]);

                new Chart(ctxServ, {
                    type: 'doughnut',
                    data: {
                        labels: data.popularityLabels, // Real Labels
                        datasets: [{
                            data: data.popularityData, // Real Data
                            backgroundColor: bgColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'right', labels: { color: 'white' } } }
                    }
                });

            } catch (e) {
                console.error("Error loading analytics:", e);
            }
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_URL}/products`);
                const products = await res.json();

                // Selects (for Item form)
                const itemSelect = document.getElementById('item-product');
                itemSelect.innerHTML = '';

                products.forEach(p => {
                    // List - HIDDEN as per request

                    // Options
                    const opt1 = document.createElement('option');
                    opt1.value = p.productId;
                    opt1.textContent = p.productName;
                    itemSelect.appendChild(opt1);
                });
            } catch (e) { console.error(e); }
        }

        async function loadSuppliers() {
            try {
                const res = await fetch(`${API_URL}/suppliers`);
                const suppliers = await res.json();
                const container = document.getElementById('supplier-list');
                const select = document.getElementById('order-supplier');
                container.innerHTML = '';
                select.innerHTML = '';

                suppliers.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'card supplier-card';
                    // Generate an initial from name
                    const initial = s.supplierName.charAt(0).toUpperCase();

                    card.innerHTML = `
                        <div class="card-content">
                            <div class="limit-head" style="margin-bottom: 20px;">
                                <div style="display:flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <div class="supplier-avatar">${initial}</div>
                                        <h3 style="margin-top: 15px;">${s.supplierName}</h3>
                                        <p style="font-size: 13px; color: var(--accent-pink); margin-bottom: 5px;">Supplier</p>
                                    </div>
                                    <button class="btn" style="padding: 5px 10px; font-size: 12px; background: transparent; border: 1px solid rgba(255,255,255,0.2);" onclick="editSupplier(${s.supplierId})">Edit</button>
                                </div>
                            </div>
                            
                            <div class="info-row" style="margin-bottom: 8px;">
                                <span style="color: var(--text-muted); font-size: 13px;"><i class="fas fa-envelope"></i> Email:</span>
                                <span style="font-size: 14px; float: right;">${s.email}</span>
                            </div>
                            <div class="info-row" style="margin-bottom: 8px;">
                                <span style="color: var(--text-muted); font-size: 13px;"><i class="fas fa-phone"></i> Phone:</span>
                                <span style="font-size: 14px; float: right;">${s.contactNumber}</span>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: var(--text-muted);">
                                ${s.address || 'No address provided'}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);

                    const option = document.createElement('option');
                    option.value = s.supplierId;
                    option.textContent = s.supplierName;
                    select.appendChild(option);
                });
            } catch (e) { console.error(e); }
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/purchase-orders`);
                const orders = await res.json();
                const tbody = document.querySelector('#orders-table tbody');
                tbody.innerHTML = '';

                orders.forEach(o => {
                    const tr = document.createElement('tr');
                    const itemsCount = o.items ? o.items.length : 0;
                    const statusClass = o.status === 'Completed' ? 'status-completed' : 'status-pending';

                    tr.innerHTML = `
                        <td style="font-weight: 600; color: white;">#${o.orderNumber}</td>
                        <td>${o.orderDate}</td>
                        <td><span class="status-badge ${statusClass}">${o.status}</span></td>
                        <td>${o.supplier ? o.supplier.supplierName : '<span style="color:var(--text-muted)">N/A</span>'}</td>
                        <td>${itemsCount} Items</td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; margin-right:5px; background: var(--accent-purple);" onclick="openItemModal(${o.purchaseOrderId})"><i class="fas fa-plus"></i> Item</button>
                            ${o.status !== 'Completed' ? `<button class="btn" style="padding: 6px 12px; font-size: 12px; background: var(--secondary-color);" onclick="markCompleted(${o.purchaseOrderId})"><i class="fas fa-check"></i> Complete</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        async function loadReturns() {
            // ... (Returns removed)
        }

        async function loadAppointments() {
            try {
                const res = await fetch(`${API_URL}/appointments`);
                const appts = await res.json();
                const tbody = document.querySelector('#appointments-table tbody');
                tbody.innerHTML = '';

                appts.forEach(a => {
                    const tr = document.createElement('tr');
                    let statusClass = 'status-pending';
                    if (a.status === 'Confirmed') statusClass = 'status-confirmed';
                    if (a.status === 'Cancelled') statusClass = 'status-cancelled';

                    tr.innerHTML = `
                        <td>${a.appointmentId}</td>
                        <td>
                            <div style="font-weight:600; color: white;">${a.customerName}</div>
                            <small style="color: var(--text-muted);">${a.contactNumber}</small>
                        </td>
                        <td>${a.service ? a.service.productName : 'N/A'}</td>
                        <td>${a.appointmentDate} <span style="color: var(--text-muted)">${a.appointmentTime}</span></td>
                        <td><span class="status-badge ${statusClass}">${a.status}</span></td>
                        <td>
                            ${a.status === 'Pending' ? `
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #00ca6d; color: #fff;" onclick="updateApptStatus(${a.appointmentId}, 'Confirmed')">Confirm</button>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #ff0055;" onclick="updateApptStatus(${a.appointmentId}, 'Cancelled')">Cancel</button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        // --- Modals ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openItemModal(orderId) {
            document.getElementById('item-order-id').value = orderId;
            openModal('item-modal');
        }

        // --- Senders ---
        async function saveProduct(e) {
            e.preventDefault();
            const catName = document.getElementById('prod-cat-new').value;
            const data = {
                productName: document.getElementById('prod-name').value,
                description: document.getElementById('prod-desc').value,
                price: parseFloat(document.getElementById('prod-price').value),
                stockQuantity: 100,
                imageUrl: document.getElementById('prod-image').value,
                category: catName ? { categoryName: catName } : null
            };
            await postData('/products', data);
            document.getElementById('product-form').reset();
            closeModal('product-modal');
            loadProducts();
        }

        // --- Senders ---
        async function editSupplier(id) {
            try {
                const res = await fetch(`${API_URL}/suppliers/${id}`);
                const s = await res.json();

                document.getElementById('supp-id').value = s.supplierId;
                document.getElementById('supp-name').value = s.supplierName;
                document.getElementById('supp-email').value = s.email;
                document.getElementById('supp-phone').value = s.contactNumber;
                document.getElementById('supp-address').value = s.address;

                openModal('supplier-modal');
            } catch (e) { console.error(e); }
        }

        async function saveSupplier(e) {
            e.preventDefault();
            const id = document.getElementById('supp-id').value;
            const data = {
                supplierName: document.getElementById('supp-name').value,
                email: document.getElementById('supp-email').value,
                contactNumber: document.getElementById('supp-phone').value,
                address: document.getElementById('supp-address').value
            };

            if (id) {
                // UPDATE
                await fetch(`${API_URL}/suppliers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // CREATE
                await postData('/suppliers', data);
            }

            document.getElementById('supplier-form').reset();
            document.getElementById('supp-id').value = '';
            closeModal('supplier-modal');
            loadSuppliers();
        }

        async function saveOrder(e) {
            e.preventDefault();
            const data = {
                orderNumber: document.getElementById('order-num').value,
                orderDate: document.getElementById('order-date').value,
                status: document.getElementById('order-status').value,
                supplier: { supplierId: document.getElementById('order-supplier').value }
            };
            await postData('/purchase-orders', data);
            document.getElementById('order-form').reset();
            closeModal('order-modal');
            loadOrders();
        }

        async function saveItem(e) {
            e.preventDefault();
            const orderId = document.getElementById('item-order-id').value;
            const data = {
                quantity: parseInt(document.getElementById('item-qty').value),
                unitPrice: parseFloat(document.getElementById('item-price').value),
                purchaseOrder: { purchaseOrderId: parseInt(orderId) },
                product: { productId: parseInt(document.getElementById('item-product').value) }
            };
            await postData('/purchase-order-items', data);
            document.getElementById('item-form').reset();
            closeModal('item-modal');
            loadOrders();
        }

        async function updateApptStatus(id, status) {
            if (status === 'Cancelled') {
                document.getElementById('cancel-appt-id').value = id;
                document.getElementById('cancel-reason').value = '';
                openModal('cancel-modal');
                return;
            }

            await fetch(`${API_URL}/appointments/${id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            loadAppointments();
        }

        async function confirmCancellation() {
            const id = document.getElementById('cancel-appt-id').value;
            const reason = document.getElementById('cancel-reason').value;

            if (!reason || reason.trim() === "") {
                alert("Please provide a reason for cancellation.");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/appointments/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Cancelled', reason: reason })
                });

                if (res.ok) {
                    closeModal('cancel-modal');
                    loadAppointments(); // Refresh table
                } else {
                    alert("Failed to cancel appointment.");
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function markCompleted(id) {
            const res = await fetch(`${API_URL}/purchase-orders/${id}`);
            const order = await res.json();
            order.status = 'Completed';

            await fetch(`${API_URL}/purchase-orders/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            loadOrders();
            loadProducts(); // Stock updates
        }

        async function postData(endpoint, data) {
            try {
                await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (e) { console.error(e); alert('Error saving data'); }
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>

</html>